class Application{static#t=!1;static#a=!1;static#i=!1;static#n=!1;static#s=!1;static#e="";static#l=()=>{};static#c=()=>{};static#d=null;static#o=null;static#g=null;static targetFrameRate=0;static vSyncCount=0;static wantsToQuit=null;static unloading=null;static quitting=null;static get isLoaded(){return this.#a}static get isPlaying(){return this.#i}static get packageName(){return this.#e}static get htmlCanvas(){return this.#d}static get gl(){return this.#o}static get gl_multidraw(){return this.#g}static isInElectron(){return navigator.userAgent.indexOf("Electron")>=0}static Init(t){this.#t||(this.#e=t,this.#d=document.createElement("canvas"),this.#d.style.margin="auto",this.#d.style.objectFit="contain",this.#o=this.#d.getContext("webgl2"),this.#o.clearColor(0,0,0,1),this.#g=this.#o.getExtension("WEBGL_multi_draw"),document.body.append(this.#d),this.#t=!0)}static Bind(t){this.#s||(this.#l=async()=>await t(),this.#c=async()=>await onUnload(),this.#s=!0)}static Quit(){this.#i&&(this.#i=!1)}static CancelQuit(){this.#i||(this.#i=!0)}static async Load(){this.#a||(await this.#l(),this.#a=!0,this.#i=!0)}static async Unload(){this.#n||(this.unloading.Invoke(),await this.#c(),this.#n=!0)}}class Window{static#i=!1;static#t=!0;static#e=!0;static#n=0;static#s=0;static#h=0;static#a=0;static#l=0;static#r=0;static#c=0;static#d=0;static#o="";static#w=null;static#g=null;static fullscreen=!1;static get fillWindow(){return this.#e}static get resizable(){return this.#t}static set resizable(i){this.#n=!0,null!=this.#g&&this.#g.invoke("SetResizable",i),this.#t=i}static set fillWindow(i){i?(Application.htmlCanvas.width=window.innerWidth-.01*this.#a*window.innerWidth,Application.htmlCanvas.height=window.innerHeight-.01*this.#l*window.innerHeight):(Application.htmlCanvas.width=this.#s,Application.htmlCanvas.height=this.#h),this.#d=Application.htmlCanvas.width/Application.htmlCanvas.height,this.#e=i}static get width(){return this.#s}static get height(){return this.#h}static get marginWidth(){return this.#a}static get marginHeight(){return this.#l}static get windowWidth(){return this.#r||this.#s}static get windowHeight(){return this.#c||this.#h}static get aspect(){return this.#d}static#p(){requestAnimationFrame(this.#u.bind(this))}static#u(){if(document.hasFocus()&&(document.fullscreenElement&&!this.fullscreen?document.exitFullscreen():!document.fullscreenElement&&this.fullscreen&&document.documentElement.requestFullscreen()),this.#n){if(!this.fullscreen){let i=this.windowWidth+(window.outerWidth-window.innerWidth)+.02*this.windowWidth*this.#a,t=this.windowHeight+(window.outerHeight-window.innerHeight)+.02*this.windowHeight*this.#l;null!=this.#g&&(i%2!=0&&(i+=i%2),t%2!=0&&(t+=t%2)),window.resizeTo(i,t)}this.#e&&(Application.htmlCanvas.width=window.innerWidth-.01*this.#a*window.innerWidth,Application.htmlCanvas.height=window.innerHeight-.01*this.#l*window.innerHeight,this.#d=Application.htmlCanvas.width/Application.htmlCanvas.height),this.#n=!1}this.#p()}static Init(i){if(!this.#i){if(this.#t=i.resizable??!0,this.fullscreen=i.fullscreen??!1,this.fillWindow=i.fillWindow??!0,this.SetTitle(i.title),this.SetResolution(i.width,i.height),this.SetMargin(i.marginWidth,i.marginHeight),this.SetWindowSize(i.windowWidth,i.windowHeight),Application.isInElectron()){const{ipcRenderer:i}=require("electron");this.#g=i}else this.SetIcon(i.icon);window.addEventListener("resize",(()=>{this.#n=!0})),this.#p(),this.#i=!0}}static SetTitle(i){this.#o=i??"Untitled",document.title=this.#o}static SetResolution(i,t){this.#s=i??250,this.#h=t??250,this.#e||(Application.htmlCanvas.width=this.#s,Application.htmlCanvas.height=this.#h,this.#d=this.#s/this.#h),0!==this.#r&&0!==this.#c||(this.#n=!0)}static SetMargin(i,t){this.#a=i??0,this.#l=t??0,Application.htmlCanvas.style.width=100-2*this.#a+"%",Application.htmlCanvas.style.height=100-2*this.#l+"%",this.#n=!0}static SetWindowSize(i,t){this.#r=i??0,this.#c=t??0,this.#n=!0}static SetIcon(i){if(this.#w=i,null==this.#w)return;if(null!=this.#g)return void this.#g.invoke("SetIcon",this.#w);let t=document.querySelector("link[rel=icon]");null==t&&(t=document.createElement("link"),t.rel="icon",document.head.append(t)),t.href=this.#w}}class CrystalEngine{static Script=class{#t=!1;#s=null;get isLoaded(){return this.#t}get src(){return this.#s}constructor(t){this.#s=t}OnLoad(){}async Load(){if(this.#t)return;const t=document.createElement("script");t.src=this.#s,t.type="text/javascript",t.async=!0,document.body.append(t),await new Promise((s=>t.addEventListener("load",s))),this.OnLoad(),this.#t=!0}};static Inner=class{static#e=!1;static#a=!1;static#i=[];static#l={libs:[],scripts:[],shaders:[]};static#n=null;static#c=class{#t=!1;#r="";#d="";#o=[];#h=[];#p=[];#s=null;get isLoaded(){return this.#t}get name(){return this.#r}get description(){return this.#d}get scripts(){return this.#h}get classes(){return this.#p}constructor(t,s,e,a,i){this.#r=t,this.#d=s??"",this.#o=e,this.#p=a??[],this.#s=i}async Load(){if(this.#t)return;for(let t=0;t<this.#o.length;t++){const s=new CrystalEngine.Script(`js/libs/${this.#s}/${this.#o[t]}.js`);await s.Load(),this.#h.push(s)}let t=[];for(let s=0;s<this.#p.length;s++)null!=this.#p[s].name&&(null==this.#p[s].args&&(this.#p[s].args=[]),t.push(this.#p[s]));this.#p=t,this.#t=!0}};static#u=class extends CrystalEngine.Script{#p=[];get classes(){return this.#p}constructor(t,s){super(t),this.#p=s??[]}OnLoad(){let t=[];for(let s=0;s<this.#p.length;s++)null!=this.#p[s].name&&(null==this.#p[s].args&&(this.#p[s].args=[]),t.push(this.#p[s]));this.#p=t}};static#m(t,s,e){return t.name===s&&t.type===e}static GetClassOfType(t,s){const e=this.#l.libs,a=this.#l.scripts;let i=null;for(let a=0;a<e.length;a++){const l=e[a].classes.find((e=>this.#m(e,t,s)));if(null!=l){i=l;break}}for(let e=0;e<a.length&&null==i;e++){const l=a[e].classes.find((e=>this.#m(e,t,s)));if(null!=l){i=l;break}}return i}static InitiateProgram(){if(this.#e)return;document.body.style.height="100vh",document.body.style.margin="0",document.body.style.display="flex",document.body.style.userSelect="none",document.body.style.color="white",document.body.style.fontFamily="monospace";let t=!1,s=null;window.addEventListener("error",(e=>{if(t)return void s.append(`\n\n${e.stack}`);t=!0,this.#a=!0,Application.isLoaded?Application.Unload():Application.htmlCanvas.style.display="none",document.body.style.margin="12px",document.body.style.display="block";const a=document.createElement("div");a.style.whiteSpace="pre-wrap",s=document.createElement("span"),s.append(e.stack);const i=document.createElement("span");i.append("\n\n\n----------\n\nPress F5 to refresh"),a.append(s,i),document.body.append(a)})),this.#e=!0,this.#b()}static async#b(){const t=await fetch("package.json"),s=await t.json();Application.Init(s.name),Window.Init(s.window);const e=await fetch("data/build.json");this.#n=await e.json(),this.#n.libs.unshift("Crystal.Core");for(let t=0;t<this.#n.libs.length;t++){const s=await fetch(`js/libs/${this.#n.libs[t]}/package.json`),e=await s.json();this.#l.libs.push(new this.#c(e.name,e.description,e.scripts,e.classes,this.#n.libs[t]))}for(let t=0;t<this.#n.scripts.length;t++){const s=this.#n.scripts[t];let e=null;e="string"==typeof s?new this.#u(`js/${s}.js`):new this.#u(`js/${s.src}.js`,s.classes),this.#l.scripts.push(e)}for(let t=0;t<this.#n.shaders.length;t++){const s=await fetch(`shaders/${this.#n.shaders[t]}.glsl`);this.#l.shaders.push(await s.text())}const a=await fetch("data/resources.json");this.#i=await a.json(),this.#y()}static async#y(){for(let t=0;t<this.#l.libs.length;t++)await this.#l.libs[t].Load();for(let t=0;t<this.#l.scripts.length;t++)await this.#l.scripts[t].Load();this.#a||(Application.targetFrameRate=this.#n.targetFrameRate,Application.vSyncCount=this.#n.vSyncCount,Time.maximumDeltaTime=this.#n.time.maximumDeltaTime,Time.timeScale=this.#n.time.timeScale,Time.fixedDeltaTime=this.#n.time.fixedDeltaTime,QuadTree.maxDepth=this.#n.partioningMaxDepth,Debug.Set(this.#n.debugMode),Shader.Set(this.#l.shaders),Resources.Set(this.#i),SortingLayer.Add(this.#n.layers),SceneManager.Set(this.#n.scenes),Input.Init(),PlayerLoop.Init())}}}window.onload=()=>{CrystalEngine.Inner.InitiateProgram()};