class Application{static#t=!1;static#i=!1;static#a=!1;static#e=!1;static#n=!1;static#s="";static#c="";static#r="";static#l=()=>{};static#d=()=>{};static#o=()=>document.hasFocus();static#h=null;static#u=null;static#g=null;static#v=null;static runInBackgroud=!1;static debugMode=!1;static targetFrameRate=0;static vSyncCount=0;static wantsToQuit=null;static unloading=null;static quitting=null;static get engineVersion(){return"2025.6.4a"}static get developer(){return this.#c}static get version(){return this.#r}static get isLoaded(){return this.#i}static get isUnloaded(){return this.#e}static get isPlaying(){return this.#a}static get name(){return this.#s}static get htmlCanvas(){return this.#h}static get gl(){return this.#u}static get gl_multidraw(){return this.#g}static get isMobilePlatform(){return navigator.userAgent.toLowerCase().indexOf("mobile")>=0}static get isInElectron(){return null!=this.#v}static get electronIPC(){return this.#v}static get isInCordova(){return null!=cordova}static get isFocused(){return this.#o()}static Init(name,dev,ver){if(!this.#t){if(this.#s=name,this.#c=dev,this.#r=ver,this.#h=document.createElement("canvas"),this.#h.style.margin="auto",this.#h.style.objectFit="contain",this.#u=this.#h.getContext("webgl2",{antialias:!1,powerPreference:"high-performance",preserveDrawingBuffer:!1}),this.#u.clearColor(0,0,0,1),this.#g=this.#u.getExtension("WEBGL_multi_draw"),document.body.append(this.#h),this.isInCordova){let t=!0;this.#o=()=>t,document.addEventListener("pause",(()=>t=!1)),document.addEventListener("resume",(()=>t=!0))}if(navigator.userAgent.indexOf("Electron")>=0){const{ipcRenderer:ipcRenderer}=require("electron");this.#v=ipcRenderer,ipcRenderer.on("eval",((event,data)=>eval(data)))}this.#t=!0}}static Bind(t,i){this.#n||(this.#l=async()=>await t(),this.#d=async()=>await i(),this.#n=!0)}static Quit(){this.#a&&(this.#a=!1)}static CancelQuit(){this.#a||(this.#a=!0)}static CompareVersion(t,i){const a=(t??"").split("."),e=(i??"").split("."),n=Math.max(a.length,e.length);for(let t=0;t<n;t++){const i=Math.max(Math.min((parseInt(a[t])||0)-(parseInt(e[t])||0),1),-1);if(0!==i)return i}return 0}static async Load(){if(!this.#i)try{await this.#l(),this.#i=!0,this.#a=!0}catch(t){throw this.#i=!0,this.#a=!0,t}}static async Unload(){if(!this.#e){try{this.unloading.Invoke()}catch{}await this.#d(),this.#e=!0}}}class Window{static#i=!1;static#t=!0;static#e=!0;static#n=!1;static#s=0;static#h=0;static#a=0;static#l=0;static#c=0;static#o=0;static#d=0;static#r=0;static#w="";static#g=null;static#p=null;static _electronMoving=!1;static fullscreen=!1;static get fillWindow(){return this.#e}static get resizable(){return this.#t}static set resizable(i){this.#s=2,null!=this.#p&&this.#p.invoke("SetResizable",i),this.#t=i}static set fillWindow(i){i?(Application.htmlCanvas.width=window.devicePixelRatio*(window.innerWidth-.01*this.#l*window.innerWidth),Application.htmlCanvas.height=window.devicePixelRatio*(window.innerHeight-.01*this.#c*window.innerHeight)):(Application.htmlCanvas.width=this.#h,Application.htmlCanvas.height=this.#a),this.#r=Application.htmlCanvas.width/Application.htmlCanvas.height,this.#e=i}static get width(){return this.#h}static get height(){return this.#a}static get marginWidth(){return this.#l}static get marginHeight(){return this.#c}static get windowWidth(){return this.#o||this.#h}static get windowHeight(){return this.#d||this.#a}static get aspect(){return this.#r}static get canvasWidth(){return window.innerWidth/window.innerHeight<this.aspect?window.innerWidth:this.aspect*window.innerHeight}static get canvasHeight(){return window.innerWidth/window.innerHeight<this.aspect?window.innerWidth/this.aspect:window.innerHeight}static#u(){requestAnimationFrame(this.#m.bind(this))}static#m(){if(document.hasFocus()&&!Application.isInCordova&&(null!=this.#p?this.#n!==this.fullscreen&&(this.#p.invoke("SetFullscreen",this.fullscreen),this.#n=this.fullscreen):document.fullscreenElement&&!this.fullscreen?document.exitFullscreen():!document.fullscreenElement&&this.fullscreen&&document.documentElement.requestFullscreen().catch((()=>{}))),this.#s>0){if(!(document.fullscreenElement||(this._electronMoving||this.#t)&&1!==this.#s||Application.isInCordova)){let i=this.windowWidth+(window.outerWidth-window.innerWidth)+.02*this.windowWidth*this.#l,t=this.windowHeight+(window.outerHeight-window.innerHeight)+.02*this.windowHeight*this.#c;i%2!=0&&(i+=i%2),t%2!=0&&(t+=t%2),window.resizeTo(i,t)}this.#e&&(Application.htmlCanvas.width=window.devicePixelRatio*(window.innerWidth-.01*this.#l*window.innerWidth),Application.htmlCanvas.height=window.devicePixelRatio*(window.innerHeight-.01*this.#c*window.innerHeight),this.#r=Application.htmlCanvas.width/Application.htmlCanvas.height),this.#s=0}this.#u()}static Init(i){this.#i||(this.#t=i.resizable??!0,this.fullscreen=i.fullscreen??!1,this.fillWindow=i.fillWindow??!0,this.SetTitle(i.title),this.SetResolution(i.width,i.height),this.SetMargin(i.marginWidth,i.marginHeight),this.SetWindowSize(i.windowWidth,i.windowHeight),this.#p=Application.electronIPC,this.SetIcon(i.icon),window.addEventListener("resize",(()=>this.#s=2)),this.#u(),this.#i=!0)}static SetTitle(i){this.#w=i??"Untitled",document.title=this.#w}static SetResolution(i,t){this.#h=i??250,this.#a=t??250,this.#e||(Application.htmlCanvas.width=this.#h,Application.htmlCanvas.height=this.#a,this.#r=this.#h/this.#a),0!==this.#o&&0!==this.#d||(this.#s=1)}static SetMargin(i,t){this.#l=i??0,this.#c=t??0,Application.htmlCanvas.style.width=100-2*this.#l+"%",Application.htmlCanvas.style.height=100-2*this.#c+"%",this.#s=1}static SetWindowSize(i,t){this.#o=i??0,this.#d=t??0,this.#s=1}static SetIcon(i){if(this.#g=i,null==this.#g)return;if(null!=this.#p)return void this.#p.invoke("SetIcon",this.#g);let t=document.querySelector("link[rel=icon]");null==t&&(t=document.createElement("link"),t.rel="icon",document.head.append(t)),t.href=this.#g}}class CrystalEngine{static Script=class{#t=!1;#e=null;get isLoaded(){return this.#t}get src(){return this.#e}constructor(t){this.#e=t}OnLoad(){}async Load(){if(this.#t)return;const t=document.createElement("script");t.src=this.#e,t.type="text/javascript",t.async=!0,document.body.append(t),await new Promise((e=>t.addEventListener("load",e))),this.OnLoad(),this.#t=!0}};static IsBehavior(className){let classCheck=eval(className).toString().replace(/\s+/g," ");const searchString=`${className} extends `,checkIndex=classCheck.indexOf(searchString);return checkIndex>=0&&(classCheck=classCheck.substring(checkIndex+searchString.length),classCheck=classCheck.substring(0,classCheck.indexOf("{")).trim(),"Behavior"===classCheck||this.IsBehavior(classCheck))}static async Wait(t){const loop=e=>{t()?e():null!=scheduler?scheduler.postTask(loop.bind(this,e)):setTimeout(loop.bind(this,e),0)};await new Promise((t=>loop(t)))}static async FetchFile(t){const e=await fetch(t);if(e.ok)return e;throw new Error(`${e.statusText} "${t}"`)}static Inner=class{static#s=!1;static#a=!1;static#i=[];static#n={libs:[],scripts:[],shaders:[]};static#l=null;static#r=class{#d=!1;#t=!1;#o="";#c="";#h="";#u="";#p=[];#m=[];#y=[];#g=[];#b=new Map;#e=null;get isLoaded(){return this.#t}get name(){return this.#o}get id(){return this.#c}get description(){return this.#h}get version(){return this.#u}get scripts(){return this.#y}get classes(){return Array.from(this.#b).map((t=>t[1]))}get deps(){return this.#p}constructor(t,e,s,a,i,n,l,r){this.#o=t,this.#c=e,this.#h=s??"",this.#u=a,this.#m=i,this.#g=n??[],this.#e=l,this.#p=r??[]}async Load(){if(this.#t)return;if(this.#d)return void await CrystalEngine.Wait((()=>this.#t));this.#d=!0;const t=this.#m.length;let e=0;for(let s=0;s<t;s++)(async()=>{await CrystalEngine.FetchFile(`js/libs/${this.#e}/${this.#m[s]}.js`),e++})();await CrystalEngine.Wait((()=>e===t));for(let t=0;t<this.#m.length;t++){const e=new CrystalEngine.Script(`js/libs/${this.#e}/${this.#m[t]}.js`);await e.Load(),this.#y.push(e)}for(let t=0;t<this.#g.length;t++){const e=this.#g[t];null!=e.type&&null!=e.name&&(null==e.args&&(e.args=[]),null==e.keys&&(e.keys=[]),0===e.type&&CrystalEngine.IsBehavior(e.name)&&e.args.push({type:"boolean",name:"enabled"}),this.#b.set(`${e.type}+${e.name}`,e))}this.#t=!0}GetClassOfType(t,e){return this.#b.get(`${e}+${t}`)}};static#D=class extends CrystalEngine.Script{#g=[];#b=new Map;get classes(){return Array.from(this.#b).map((t=>t[1]))}constructor(t,e){super(t),this.#g=e??[]}OnLoad(){for(let t=0;t<this.#g.length;t++){const e=this.#g[t];null!=e.type&&null!=e.name&&(null==e.args&&(e.args=[]),null==e.keys&&(e.keys=[]),0===e.type&&CrystalEngine.IsBehavior(e.name)&&e.args.push({type:"boolean",name:"enabled"}),this.#b.set(`${e.type}+${e.name}`,e))}}GetClassOfType(t,e){return this.#b.get(`${e}+${t}`)}};static GetClassOfType(t,e){const s=this.#n.libs,a=this.#n.scripts;let i=null;for(let s=0;s<a.length;s++){const n=a[s].GetClassOfType(t,e);if(null!=n){i=n;break}}for(let a=0;a<s.length&&null==i;a++){const n=s[a].GetClassOfType(t,e);if(null!=n){i=n;break}}return i}static InitiateProgram(){if(this.#s)return;document.body.style.height="100vh",document.body.style.margin="0",document.body.style.display="flex",document.body.style.userSelect="none",document.body.style.color="white",document.body.style.fontFamily='Consolas, "Courier New", monospace',document.body.style.overflow="clip";let t=null;const onError=e=>{if(this.#a)return void t.append(`\n\n${e?.stack??"Unidentified error :("}`);this.#a=!0,Application.isLoaded?(PlayerLoop.OnError(),Application.Unload()):Application.htmlCanvas.style.display="none",document.body.style.height="",document.body.style.overflow="",Window.resizable=!0;const s=document.createElement("div");s.style.whiteSpace="pre",s.style.padding="12px 24px",s.style.paddingTop=Application.isMobilePlatform?"12px":"24px",t=document.createElement("span"),t.style.userSelect="text",t.append(e?.stack??"Unidentified error :(");const a=document.createElement("span");a.append("\n\n\n----------\n\nPlease report this problem"),s.append(t,a),document.body.append(s)};window.addEventListener("error",(t=>onError(t.error))),window.addEventListener("unhandledrejection",(t=>onError(t.reason))),Application.isInCordova&&window.addEventListener("cordovacallbackerror",(t=>onError(t.error))),this.#s=!0,this.#f()}static async#f(){let t=!1;(async()=>{const e=await CrystalEngine.FetchFile("manifest.json"),s=await e.json();Application.Init(s.name,s.developer,s.version),Window.Init(s.window),t=!0})();const e=await CrystalEngine.FetchFile("data/build.json");this.#l=await e.json(),this.#l.libs.unshift("Crystal.Core"),this.#l.shaders.unshift("vertex","fragment");const s=this.#l.libs.length+this.#l.shaders.length+this.#l.resources.length;let a=0;for(let t=0;t<this.#l.libs.length;t++)(async()=>{const e=await CrystalEngine.FetchFile(`js/libs/${this.#l.libs[t]}/manifest.json`),s=await e.json();"com.crystal.core"!==s.id&&(null==s.deps&&(s.deps=[]),s.deps.unshift("com.crystal.core")),this.#n.libs.push(new this.#r(s.name,s.id,s.description,s.version,s.scripts,s.classes,this.#l.libs[t],s.deps)),a++})();for(let t=0;t<this.#l.scripts.length;t++){const e=this.#l.scripts[t];let s=null;s="string"==typeof e?new this.#D(`js/${e}.js`):new this.#D(`js/${e.src}.js`,e.classes),this.#n.scripts.push(s)}for(let t=0;t<this.#l.shaders.length;t++)(async()=>{const e=await CrystalEngine.FetchFile(`shaders/${this.#l.shaders[t]}.glsl`);this.#n.shaders.push(await e.text()),a++})();for(let t=0;t<this.#l.resources.length;t++)(async()=>{const e=await CrystalEngine.FetchFile(`data/resources/${this.#l.resources[t]}.json`),s=await e.json();this.#i.push(...s),a++})();await CrystalEngine.Wait((()=>t&&a===s)),this.#w()}static async#w(){const t=this.#n.libs.length;let e=0;for(let s=0;s<t;s++)(async()=>{const t=this.#n.libs[s].deps;let a=0;for(let e=0;e<t.length;e++)(async()=>{const s=this.#n.libs.find((s=>s.id===t[e]));await s.Load(),a++})();await CrystalEngine.Wait((()=>a===t.length)),await this.#n.libs[s].Load(),e++})();await CrystalEngine.Wait((()=>e===t));for(let t=0;t<this.#n.scripts.length;t++)await this.#n.scripts[t].Load();this.#a||(Application.targetFrameRate=this.#l.targetFrameRate,Application.vSyncCount=this.#l.vSyncCount,Application.runInBackground=this.#l.runInBackground,Application.debugMode=this.#l.debugMode,Time.maximumDeltaTime=this.#l.time.maximumDeltaTime,Time.timeScale=this.#l.time.timeScale,Time.fixedDeltaTime=this.#l.time.fixedDeltaTime,PlayerLoop.noFixedUpdate=this.#l.noFixedUpdate,QuadTree.maxDepth=this.#l.partioningMaxDepth,GamepadInput.leftStickDeadzone=new Vector2(this.#l.input.gamepad.leftStickDeadzone.min,this.#l.input.gamepad.leftStickDeadzone.max),GamepadInput.rightStickDeadzone=new Vector2(this.#l.input.gamepad.rightStickDeadzone.min,this.#l.input.gamepad.rightStickDeadzone.max),Shader.Set(this.#n.shaders),this.#a||(Resources.Set(this.#i),this.#a||(SortingLayer.Add(this.#l.layers),SceneManager.Set(this.#l.scenes),this.#a||(Input.Init(),PlayerLoop.Init()))))}}}Application.isInCordova?(document.addEventListener("deviceready",(()=>CrystalEngine.Inner.InitiateProgram())),document.addEventListener("backbutton",(n=>n.preventDefault()))):window.onload=()=>CrystalEngine.Inner.InitiateProgram();